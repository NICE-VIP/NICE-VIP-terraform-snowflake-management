name: Terraform Plan

on:
  pull_request:
    branches:
      - main

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    env:
      TF_VAR_snowflake_organization_name: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}
      TF_VAR_snowflake_account_name: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
      TF_VAR_snowflake_user: ${{ secrets.SNOWFLAKE_USER }}
      TF_VAR_snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}

      TF_VAR_snowflake_organization_name_2: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME_2 }}
      TF_VAR_snowflake_account_name_2: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME_2 }}
      TF_VAR_snowflake_user_2: ${{ secrets.SNOWFLAKE_USER_2 }}
      TF_VAR_snowflake_password_2: ${{ secrets.SNOWFLAKE_PASSWORD_2 }}

      TF_CLOUD_ORGANIZATION: "nice-vip"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_WORKSPACE: "nice-renew-monitoring"

      PUSHGATEWAY_URL: ${{ secrets.MONITOR_VM_IP }}
      PUSHGATEWAY_JOB: "terraform_plan"
      TERRAFORM_PLAN_PATH: terraform_plan-${{ github.run_id }}.json
      GITHUB_RUN_ID: ${{ github.run_id }} 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.11.4

      - name: Terraform Init
        run: terraform init 

      - name: Terraform Refresh
        run: terraform refresh 

      - name: Terraform Plan 
        run: terraform plan -out=tfplan | tee terraform-plan-${{ github.run_id }}.log

      - name: Generate Plan JSON
        run: |
          echo "Generating Terraform Plan JSON"
          terraform show -json tfplan > raw_plan.json

          # Clean the JSON: Remove any line(s) before the first JSON object
          sed -n '/^{/,$p' raw_plan.json > terraform_plan-${{ github.run_id }}.json


      - name: Checkout Exporter Repo
        uses: actions/checkout@v4
        with:
          repository: Samir-Wankhede/terraform-prometheus-pushgateway-exporter
          path: exporter

      - name: Move JSON into exporter
        run: mv terraform_plan-${{ github.run_id }}.json exporter/

      - name: Run Go Metrics Exporter
        run: |
          cd exporter
          go mod tidy
          go build -o exporter .
          ./exporter
      
      - name: Send Plan log to monitoring VM
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.MONITOR_VM_IP }}
          username: ${{ secrets.MONITOR_VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: terraform-plan-${{ github.run_id }}.log
          target: "/opt/terraform-logs/"

      - name: Send Plan JSON to monitoring VM
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.MONITOR_VM_IP }}
          username: ${{ secrets.MONITOR_VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: exporter/terraform_plan-${{ github.run_id }}.json
          target: "/opt/terraform-logs/"

          